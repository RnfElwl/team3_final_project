<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ict.backend.dao.UserDAO">
    <select id = "test" resultType="com.ict.backend.vo.MemberVO">
        select * from user_tbl limit 1
    </select>
<!--    <select id="findByUserid" parameterType="String" resultType="com.ict.backend.vo.MemberVO">-->
<!--        SELECT * FROM user_tbl WHERE userid = #{userid}-->
<!--    </select>-->
    <select id="findByUserid" parameterType="String" resultType="com.ict.backend.vo.MemberVO">
        SELECT u.*, CASE a.authority
        WHEN 1 THEN 'ADMIN' ELSE 'USER' END AS role,
        it.image_url
        FROM user_tbl u
        left JOIN admin_grade_tbl a ON u.userid = a.userid
        left join image_tbl it on u.userprofile=it.image_no
        where u.userid = #{userid};
    </select>

    <select id="existsByUserid" parameterType="String" resultType="Boolean">
        SELECT EXISTS(SELECT 1 FROM user_tbl WHERE userid = #{userid})
    </select>

    <insert id="saveUser" parameterType="com.ict.backend.vo.MemberVO">
        INSERT INTO user_tbl(userid, userpwd, username, usernick, usertel, useraddr, zipcode, addrdetail, userbirth, gender) VALUES(#{userid}, #{userpwd}, #{username}, #{usernick}, #{usertel}, #{useraddr}, #{zipcode}, #{addrdetail}, #{userbirth}, #{gender})
    </insert>

    <select id="usernickcheck" resultType="int">
        select count(*) from user_tbl where usernick = #{param1}
    </select>
    <select id="useridcheck" resultType="int">
        select count(*) from user_tbl where userid = #{param1}
    </select>
    <select id ="getuserpwd">
        select userpwd from user_tbl where userid = #{userid};
    </select>
    <select id = "getUserInfo" resultType="com.ict.backend.vo.MemberVO">
        SELECT userid, usernick, username, DATE_FORMAT(userbirth, '%Y.%m.%d') AS userbirth, usertel, useremail, useraddr, zipcode, addrdetail, gender
        FROM user_tbl
        WHERE userid = #{userid}
    </select>
    <select id = "getOtherUserInfo" resultType="com.ict.backend.vo.MemberVO">
        SELECT userid, usernick, username, DATE_FORMAT(userbirth, '%Y.%m.%d') AS userbirth, usertel, useremail, useraddr, zipcode, addrdetail, gender, i.image_url as userprofile
        FROM user_tbl u join image_tbl i on u.userprofile = i.image_no
        WHERE usernick = #{usernick};
    </select>
<!--    <select id = "getUserInfo" resultType="com.ict.backend.vo.MemberVO">-->
<!--        SELECT-->
<!--        userid, usernick, username, userbirth, usertel, useremail, useraddr, zipcode, addrdetail, image_url AS userprofile-->
<!--        FROM user_tbl u-->
<!--        JOIN image_tbl i ON u.userprofile = i.image_no-->
<!--        WHERE u.userid = #{userid};-->
<!--    </select>-->
    <update id = "updateUserInfo">
        UPDATE user_tbl SET
        usernick = #{usernick}, userbirth = #{userbirth}, usertel = #{usertel}, useremail = #{useremail}, useraddr = #{useraddr}, zipcode = #{zipcode}, addrdetail = #{addrdetail}
        where userid = #{userid}
    </update>
    <update id="changepassword">
        UPDATE user_tbl SET userpwd = #{userpwd} where userid = #{userid}
    </update>

    <select id="userprofile" resultType="String">
        SELECT i.image_url
        FROM user_tbl u
        LEFT JOIN image_tbl i ON u.userprofile = i.image_no
        WHERE u.userid = #{userid};
    </select>


    <insert id="uploadImage" useGeneratedKeys="true" keyProperty="image_no">
        INSERT INTO image_tbl (image_url) VALUES (#{image_url})
    </insert>

    <update id="updateprofile">
        UPDATE user_tbl SET userprofile = #{param1} WHERE userid = #{param2}
    </update>
    <select id="userprofileno" resultType="int">
        select userprofile from user_tbl  where userid = #{parma1}
    </select>
    <update id = "updateimageurl">
        UPDATE image_tbl set image_url = #{param1} where image_no = #{param2}
    </update>
    <select id="getBookmarks" resultType="map">
        SELECT m.movie_kor, m.movie_code, m.movie_link FROM bookmark_tbl b JOIN movie_data_tbl m ON b.movie_no = m.movie_no WHERE b.userid = #{userid}
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    <select id="getCountBookmarks" resultType="int">
        SELECT count(*) FROM bookmark_tbl WHERE userid = #{userid}
    </select>
    <select id="getHistory" resultType="map">
        select m.movie_kor, m.movie_code, m.movie_link from history_sec_tbl h join movie_data_tbl m on h.movie_no = m.movie_no where h.userid = #{userid}
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    <select id="getCountHistory" resultType="int">
        SELECT count(*) FROM history_sec_tbl where userid = #{userid}
    </select>
    <select id ="getfollower" resultType="map">
        SELECT u.usernick, i.image_url FROM  follower_tbl f JOIN user_tbl u ON f.follower_userid = u.userid
        JOIN  image_tbl i ON i.image_no = u.userprofile
        WHERE  f.userid = #{userid}
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    <select id ="getfollowing" resultType="map">
        SELECT u.usernick, i.image_url FROM  follower_tbl f JOIN user_tbl u ON f.follower_userid = u.userid
        JOIN  image_tbl i ON i.image_no = u.userprofile
        WHERE  f.follower_userid = #{userid}
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    <select id ="getCountfollower" resultType="int">
        SELECT count(*) FROM  follower_tbl where userid = #{userid}
    </select>
    <select id ="getCountfollowing" resultType="int">
        SELECT count(*) FROM  follower_tbl where follower_userid = #{userid}
    </select>
    <select id="getCountCommunity" resultType = "int">
        SELECT count(*) FROM community_tbl where userid = #{userid};
    </select>
    <select id="getCountComment" resultType = "int">
        SELECT count(*) FROM community_comment_tbl where userid = #{userid};
    </select>
    <select id ="getCountReplyComment" resultType="int">
        SELECT count(*) FROM reply_comment_tbl where userid = #{userid};
    </select>

    <select id="getFollowData" resultType = "map">
        SELECT
        f1.follower_userid AS following_user,
        u1.usernick AS following_user_nick,
        i1.image_url AS following_user_image,
        f2.userid AS follower_user,
        u2.usernick AS follower_user_nick,
        i2.image_url AS follower_user_image
        FROM  follower_tbl AS f1
        LEFT JOIN follower_tbl AS f2 ON f1.follower_userid = f2.userid AND f2.follower_userid = f1.userid
        LEFT JOIN user_tbl AS u1 ON f1.follower_userid = u1.userid
        LEFT JOIN image_tbl AS i1 ON i1.image_no = u1.userprofile
        LEFT JOIN user_tbl AS u2 ON f2.userid = u2.userid
        LEFT JOIN image_tbl AS i2 ON i2.image_no = u2.userprofile
        WHERE f1.userid = #{userid};
    </select>


</mapper>