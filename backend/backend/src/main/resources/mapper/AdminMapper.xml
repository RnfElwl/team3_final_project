<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ict.backend.dao.AdminDAO">
    <select id = "qnaDataSelectMonth" resultType="com.ict.backend.vo.AdminVO">
        SELECT MONTH(qna_writedate) AS qna_date, COUNT(qna_title) AS qna_count
        FROM qna_tbl
        WHERE YEAR(qna_writedate) = YEAR(CURDATE())
        GROUP BY MONTH(qna_writedate)
    </select>
    <select id = "qnaDataSelectYear" resultType="com.ict.backend.vo.AdminVO">
        SELECT YEAR(qna_writedate) AS 'qna_date', COUNT(qna_title) AS 'qna_count'
        FROM qna_tbl
        WHERE YEAR(qna_writedate) BETWEEN YEAR(NOW()) - 7 AND YEAR(NOW())
        GROUP BY YEAR(qna_writedate)
    </select>
    <select id = "qnaDataSelectDay" resultType="com.ict.backend.vo.AdminVO">
        select
        date_format(date_add(curdate(), interval -7 + n.n day), '%y.%m.%d') as qna_date,
        count(q.qna_title) as qna_count
        from
        (select 1 as n union all select 2 union all select 3 union all select 4 union all
        select 5 union all select 6 union all select 7 union all select 8 union all
        select 9 union all select 10 union all select 11 union all select 12 union all
        select 13 union all select 14 union all select 15 union all select 16 union all
        select 17 union all select 18 union all select 19 union all select 20 union all
        select 21 union all select 22 union all select 23 union all select 24 union all
        select 25 union all select 26 union all select 27 union all select 28 union all
        select 29 union all select 30 union all select 31) n
        left join
        qna_tbl q on date(q.qna_writedate) = date_add(curdate(), interval -7 + n.n day)
        where
        date_add(curdate(), interval -7 + n.n day)
        between date(now() - interval 7 day) and curdate()
        group by qna_date
        order by qna_date;
    </select>
    <select id = "communityDataSelectMonth" resultType="com.ict.backend.vo.AdminVO">
        SELECT MONTH(community_writedate) AS community_date, COUNT(community_title) AS community_count
        FROM community_tbl
        WHERE YEAR(community_writedate) = YEAR(CURDATE())
        GROUP BY MONTH(community_writedate)
    </select>
    <select id = "communityDataSelectYear" resultType="com.ict.backend.vo.AdminVO">
        with years as (
        select year(now()) as year union all
        select year(now()) - 1 union all
        select year(now()) - 2 union all
        select year(now()) - 3
        )
        select y.year as 'community_date',
        coalesce(count(c.community_title), 0) as 'community_count'
        from years y
        left join community_tbl c
        on year(c.community_writedate) = y.year
        group by y.year
        order by y.year;
    </select>
    <select id = "communityDataSelectDay" resultType="com.ict.backend.vo.AdminVO">
        select
        date_format(date_add(curdate(), interval -7 + n.n day), '%y.%m.%d') as community_date,
        count(c.community_title) as community_count
        from
        (select 1 as n union all select 2 union all select 3 union all select 4 union all
        select 5 union all select 6 union all select 7 union all select 8 union all
        select 9 union all select 10 union all select 11 union all select 12 union all
        select 13 union all select 14 union all select 15 union all select 16 union all
        select 17 union all select 18 union all select 19 union all select 20 union all
        select 21 union all select 22 union all select 23 union all select 24 union all
        select 25 union all select 26 union all select 27 union all select 28 union all
        select 29 union all select 30 union all select 31) n
        left join
        community_tbl c on date(c.community_writedate) = date_add(curdate(), interval -7 + n.n day)
        where
        date_add(curdate(), interval -7 + n.n day)
        between date(now() - interval 7 day) and curdate()
        group by community_date
        order by community_date;
    </select>
    <select id="qnaSearch" resultType="com.ict.backend.vo.AdminVO">
        select date(qna_writedate) as 'qna_date', count(qna_title) as 'qna_count'
        from qna_tbl
        where date(qna_writedate) between STR_TO_DATE(#{start_qnaDate}, '%Y-%m-%d')
        and STR_TO_DATE(#{end_qnaDate}, '%Y-%m-%d')
        group by date(qna_writedate);
    </select>
    <select id="comSearch" resultType="com.ict.backend.vo.AdminVO">
        select date(community_writedate) as 'community_date', count(community_title) as 'community_count'
        from community_tbl
        where date(community_writedate) between STR_TO_DATE(#{start_comDate}, '%Y-%m-%d')
        and STR_TO_DATE(#{end_comDate}, '%Y-%m-%d')
        group by date(community_writedate);
    </select>
    <select id="dailySubscriberSelect" resultType="int">
        SELECT IFNULL(COUNT(userid), 0) as todayUCount
        FROM user_tbl
        WHERE DATE(regiserdate) = DATE(NOW())
    </select>
    <select id="dailyCommunitySelect" resultType="int">
        select ifnull(count(community_title),0) as todayCCount
        from community_tbl
        where date(community_writedate)=date(now())
    </select>
    <select id="dailyQnaSelect" resultType="int">
        select ifnull(count(qna_title),0) as todayQCount
        from qna_tbl
        where date(qna_writedate)=date(now())
    </select>
    <select id="dailyRepSelect" resultType="int">
        select ifnull(count(report_userid),0) as todayRCount
        from report_tbl
        where date(report_date)=date(now())
    </select>
    <select id="selectMemberMin" resultType="com.ict.backend.vo.MemberVO">
        select userid, username, DATE_FORMAT(regiserdate, '%y.%m.%d') AS regiserdate, active_state from user_tbl
        order by regiserdate desc limit 5
    </select>
    <select id = "getQnAList" resultType="com.ict.backend.vo.QnAVO">
        select qna_no, userid, head_title, qna_title,date_format(qna_writedate, '%y-%m-%d %H:%i') qna_writedate,
        privacyQ,qna_state,active_state,qna_pwd from qna_tbl
        <if test="searchWord!=null and searchWord!=''">
            where ${searchKey} like '%${searchWord}%'
        </if>
        order by qna_writedate desc
        limit ${onePageRecord} offset ${offset}
    </select>
    <select id="getTotalQnARecord" resultType="int">
        select count(qna_no) from qna_tbl
        <if test="searchWord!=null and searchWord!=''">
            where ${searchKey} like '%${searchWord}%'
        </if>
    </select>
    <update id="insertQnaAnswer">
        update qna_tbl set
        answer_user=#{answer_user},
        qna_answer=#{qna_answer},
        qna_state=#{qna_state},
        qna_answer_date=now()
        where qna_no=#{qna_no}
    </update>
    <update id="updateQnaActive">
        UPDATE qna_tbl
        SET active_state = #{activeState}
        WHERE qna_no IN
        <foreach item="qnaNo" collection="qnaNos" open="(" separator="," close=")">
            #{qnaNo}
        </foreach>
    </update>
    <select id="getMemList" resultType="com.ict.backend.vo.MemberVO">
        select userid, username, usernick, gender,usertel, u.active_state,
        count(r.reported_userid) as 'reported_count',lastvisite,regiserdate
        from user_tbl u left join report_tbl r on u.userid=r.reported_userid
        <if test="searchWord!=null and searchWord!=''">
        where ${searchKey} like '%${searchWord}%'
        </if>
        GROUP BY
        u.userid, u.username, u.usernick, u.gender, u.usertel, u.active_state, u.lastvisite, u.regiserdate
    </select>
    <select id="getRepList" resultType="com.ict.backend.vo.ReportVO">
        select report_no,report_userid, reported_userid, report_content, report_tblname, report_state,
        report_date, report_type, report_reason, edit_date,edit_state,edit_user,active_state,report_tblno,report_tbluuid from report_tbl
        <if test="searchWord!=null and searchWord!=''">
            AND ${searchKey} LIKE CONCAT('%', #{searchWord}, '%')
        </if>
    </select>
    <select id="getRepView" resultType="com.ict.backend.vo.ReportVO">
        select report_no,report_userid, reported_userid, report_content, report_tblname, report_state,
        report_date, report_type, report_reason, edit_date,edit_state,edit_user,active_state,report_tblno,report_tbluuid from report_tbl
        where report_no=${report_no}
    </select>
    <update id="updateMemActive">
        UPDATE user_tbl
        SET active_state = #{activeState}
        WHERE userid IN
        <foreach item="useridd" collection="userids" open="(" separator="," close=")">
            #{useridd}
        </foreach>
    </update>

    <select id="getComList" parameterType="map" resultType="com.ict.backend.vo.CommunityVO">
        SELECT c.community_no, c.userid, c.community_title, c.community_content,
        COUNT(cl.community_no) AS community_like, c.community_writedate, c.hit,
        c.edit_date, c.edit_state, c.edit_user, c.active_state, c.category, c.privacy
        FROM community_tbl c LEFT JOIN community_like_tbl cl ON c.community_no = cl.community_no


        <where>
            -- 검색 조건 (searchKey, searchWord)
            <if test="searchKey != null and searchKey != '' and searchWord != null and searchWord != ''">
                ${searchKey} LIKE CONCAT('%', #{searchWord}, '%')
            </if>

             -- 상태 필터 (active_state)
            <if test="activeStateChk != null and activeStateChk != ''">
                ${activeStateChk} like CONCAT('%', #{stateChk}, '%')
            </if>
        </where>

        GROUP BY c.community_no, c.userid, c.community_title, c.community_content,
        c.community_writedate, c.hit, c.edit_date,
        c.edit_state, c.edit_user, c.active_state,
        c.category, c.privacy
        LIMIT #{onePageRecord} OFFSET #{offset}


    </select>
    <select id="getTotalComRecord" resultType="int">
        select count(*) from community_tbl
        <if test="searchWord != null and searchWord != ''">
            where ${searchKey} like '%${searchWord}%'
        </if>
    </select>
    <select id="selectAdminMovieList" resultType="com.ict.backend.vo.MovieVO">
        select * from movie_data_tbl
        <if test="searchKey=='movie_title'">
            where movie_kor like '%${word}%' or movie_eng like '%${word}%';
        </if>
        <if test="searchKey!='movie_title'">
            where ${searchKey} like '%${word}%';
        </if>
    </select>
    <update id="updateMovieActive">
        UPDATE movie_data_tbl
        SET active_state = ${param1}
        WHERE userid IN
        <foreach item="no" collection="movie_no" open="(" separator="," close=")">
            #{no}
        </foreach>
    </update>
</mapper>